<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automated Document Status Tests</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1976d2;
            border-bottom: 3px solid #1976d2;
            padding-bottom: 10px;
        }
        .test-results {
            margin: 30px 0;
        }
        .test-case {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
        }
        .test-case.pass {
            border-color: #4caf50;
            background: #e8f5e9;
        }
        .test-case.fail {
            border-color: #f44336;
            background: #ffebee;
        }
        .test-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .test-title .status {
            float: right;
            padding: 5px 15px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .test-title .pass {
            background: #4caf50;
            color: white;
        }
        .test-title .fail {
            background: #f44336;
            color: white;
        }
        .test-details {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        .expected, .actual {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .expected {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        .actual {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
        }
        .error {
            background: #ffebee;
            border-left: 4px solid #f44336;
            color: #c62828;
        }
        button {
            padding: 12px 24px;
            margin: 10px 5px;
            font-size: 1em;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            background: #1976d2;
            color: white;
            transition: background 0.2s;
        }
        button:hover {
            background: #1565c0;
        }
        button.danger {
            background: #f44336;
        }
        button.danger:hover {
            background: #d32f2f;
        }
        .summary {
            padding: 20px;
            margin: 20px 0;
            background: #e3f2fd;
            border-radius: 8px;
            border-left: 5px solid #1976d2;
        }
        .summary h2 {
            margin-top: 0;
            color: #1976d2;
        }
        .stats {
            display: flex;
            gap: 30px;
            margin-top: 15px;
        }
        .stat {
            padding: 15px;
            background: white;
            border-radius: 4px;
            flex: 1;
            text-align: center;
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        .stat-label {
            color: #666;
            font-size: 0.9em;
        }
        .instructions {
            background: #fff8e1;
            border: 1px solid #ffc107;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .instructions h3 {
            margin-top: 0;
            color: #f57c00;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Automated Document Status Tests</h1>
        
        <div class="instructions">
            <h3>‚ö†Ô∏è Instructions</h3>
            <ol>
                <li>Make sure you have cases in localStorage with document status</li>
                <li>Click "Run All Tests" to execute automated verification</li>
                <li>Review the results below</li>
                <li>Use "Clear All Data" if you want to start fresh</li>
            </ol>
        </div>

        <div>
            <button onclick="runAllTests()">‚ñ∂Ô∏è Run All Tests</button>
            <button onclick="createTestData()">üìù Create Test Data</button>
            <button onclick="viewLocalStorage()">üëÅÔ∏è View localStorage</button>
            <button onclick="clearAllData()" class="danger">üóëÔ∏è Clear All Data</button>
        </div>

        <div id="summary" class="summary" style="display: none;">
            <h2>Test Summary</h2>
            <div class="stats">
                <div class="stat">
                    <div class="stat-value" id="total-tests">0</div>
                    <div class="stat-label">Total Tests</div>
                </div>
                <div class="stat">
                    <div class="stat-value" style="color: #4caf50;" id="passed-tests">0</div>
                    <div class="stat-label">Passed</div>
                </div>
                <div class="stat">
                    <div class="stat-value" style="color: #f44336;" id="failed-tests">0</div>
                    <div class="stat-label">Failed</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="success-rate">0%</div>
                    <div class="stat-label">Success Rate</div>
                </div>
            </div>
        </div>

        <div id="results" class="test-results"></div>
    </div>

    <script>
        const tests = [];
        let passCount = 0;
        let failCount = 0;

        function addTest(name, testFn) {
            tests.push({ name, testFn });
        }

        function assertEquals(actual, expected, message) {
            if (JSON.stringify(actual) !== JSON.stringify(expected)) {
                throw new Error(`${message}\nExpected: ${JSON.stringify(expected, null, 2)}\nActual: ${JSON.stringify(actual, null, 2)}`);
            }
        }

        function assertNotNull(value, message) {
            if (value === null || value === undefined) {
                throw new Error(`${message}\nValue was ${value}`);
            }
        }

        function assertTrue(condition, message) {
            if (!condition) {
                throw new Error(message);
            }
        }

        // Test 1: Verify cases exist in localStorage
        addTest("localStorage Contains Cases", () => {
            const saved = localStorage.getItem('greekCitizenshipCases');
            assertNotNull(saved, "localStorage should contain cases");
            
            const cases = JSON.parse(saved);
            assertTrue(cases.length > 0, "Should have at least one case");
            
            return {
                expected: "At least 1 case in localStorage",
                actual: `Found ${cases.length} case(s)`
            };
        });

        // Test 2: Verify documentStatus field exists
        addTest("Cases Have documentStatus Field", () => {
            const saved = localStorage.getItem('greekCitizenshipCases');
            const cases = JSON.parse(saved);
            
            const casesWithDocStatus = cases.filter(c => c.documentStatus !== undefined);
            assertTrue(casesWithDocStatus.length > 0, "At least one case should have documentStatus field");
            
            return {
                expected: "All cases have documentStatus field",
                actual: `${casesWithDocStatus.length} out of ${cases.length} cases have documentStatus`
            };
        });

        // Test 3: Verify documentStatus structure
        addTest("documentStatus Has Correct Structure", () => {
            const saved = localStorage.getItem('greekCitizenshipCases');
            const cases = JSON.parse(saved);
            
            const caseWithDocs = cases.find(c => 
                c.documentStatus && Object.keys(c.documentStatus).length > 0
            );
            
            if (!caseWithDocs) {
                throw new Error("No case found with document status entries. Please check some document checkboxes first.");
            }
            
            const firstDocId = Object.keys(caseWithDocs.documentStatus)[0];
            const firstDocStatus = caseWithDocs.documentStatus[firstDocId];
            
            assertTrue(
                firstDocStatus.hasOwnProperty('received'),
                "Document status should have 'received' property"
            );
            
            return {
                expected: "Document status has {received: true/false, alternativeUsed?: number}",
                actual: `Found structure: ${JSON.stringify(firstDocStatus)}`
            };
        });

        // Test 4: Simulate save operation
        addTest("Save Operation Preserves documentStatus", () => {
            const saved = localStorage.getItem('greekCitizenshipCases');
            const cases = JSON.parse(saved);
            
            if (cases.length === 0) {
                throw new Error("No cases available for testing");
            }
            
            // Simulate the OLD broken behavior vs NEW fixed behavior
            const testCase = cases[0];
            const originalDocStatus = testCase.documentStatus;
            
            // Create new case object (simulating saveCase())
            const newCaseObj = {
                id: testCase.id,
                data: testCase.data,
                category: testCase.category
                // documentStatus is missing (OLD BUG)
            };
            
            // OLD BEHAVIOR: Would lose documentStatus
            const wouldLoseData = !newCaseObj.documentStatus;
            
            // NEW BEHAVIOR: Preserve documentStatus
            newCaseObj.documentStatus = originalDocStatus;
            const dataPreserved = !!newCaseObj.documentStatus;
            
            assertTrue(dataPreserved, "documentStatus should be preserved in new object");
            assertEquals(
                newCaseObj.documentStatus,
                originalDocStatus,
                "Preserved documentStatus should match original"
            );
            
            return {
                expected: "documentStatus preserved after save",
                actual: `Old behavior would lose: ${wouldLoseData}, New behavior preserves: ${dataPreserved}`
            };
        });

        // Test 5: Test alternative selection persistence
        addTest("Alternative Selections Persist", () => {
            const saved = localStorage.getItem('greekCitizenshipCases');
            const cases = JSON.parse(saved);
            
            const caseWithAlt = cases.find(c => {
                if (!c.documentStatus) return false;
                return Object.values(c.documentStatus).some(ds => ds.alternativeUsed !== undefined && ds.alternativeUsed !== null);
            });
            
            if (!caseWithAlt) {
                // Create a test case with alternative
                const testCase = cases[0];
                if (!testCase.documentStatus) testCase.documentStatus = {};
                testCase.documentStatus['test_doc'] = { received: true, alternativeUsed: 2 };
                localStorage.setItem('greekCitizenshipCases', JSON.stringify(cases));
                
                return {
                    expected: "Alternative selection stored",
                    actual: "Created test alternative selection"
                };
            }
            
            const docWithAlt = Object.entries(caseWithAlt.documentStatus)
                .find(([_, ds]) => ds.alternativeUsed !== undefined && ds.alternativeUsed !== null);
            
            assertTrue(docWithAlt !== undefined, "Should find document with alternative");
            assertTrue(
                typeof docWithAlt[1].alternativeUsed === 'number',
                "alternativeUsed should be a number"
            );
            
            return {
                expected: "Alternative selections stored as numbers",
                actual: `Found alternative index: ${docWithAlt[1].alternativeUsed}`
            };
        });

        // Test 6: Test checkbox state
        addTest("Checkbox State Correctly Stored", () => {
            const saved = localStorage.getItem('greekCitizenshipCases');
            const cases = JSON.parse(saved);
            
            const caseWithDocs = cases.find(c => 
                c.documentStatus && Object.keys(c.documentStatus).length > 0
            );
            
            if (!caseWithDocs) {
                throw new Error("No case with documents found");
            }
            
            const docStatuses = Object.values(caseWithDocs.documentStatus);
            const checkedDocs = docStatuses.filter(ds => ds.received === true);
            const uncheckedDocs = docStatuses.filter(ds => ds.received === false);
            
            assertTrue(
                checkedDocs.length > 0 || uncheckedDocs.length > 0,
                "Should have at least some document states"
            );
            
            return {
                expected: "Documents have explicit true/false received states",
                actual: `Checked: ${checkedDocs.length}, Unchecked: ${uncheckedDocs.length}, Total: ${docStatuses.length}`
            };
        });

        function runAllTests() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<h2>Running Tests...</h2>';
            
            passCount = 0;
            failCount = 0;
            
            setTimeout(() => {
                let html = '';
                
                tests.forEach(test => {
                    try {
                        const result = test.testFn();
                        passCount++;
                        html += `
                            <div class="test-case pass">
                                <div class="test-title">
                                    ‚úÖ ${test.name}
                                    <span class="status pass">PASS</span>
                                </div>
                                <div class="test-details">
                                    <div class="expected">
                                        <strong>Expected:</strong><br>
                                        ${result.expected}
                                    </div>
                                    <div class="actual">
                                        <strong>Actual:</strong><br>
                                        ${result.actual}
                                    </div>
                                </div>
                            </div>
                        `;
                    } catch (error) {
                        failCount++;
                        html += `
                            <div class="test-case fail">
                                <div class="test-title">
                                    ‚ùå ${test.name}
                                    <span class="status fail">FAIL</span>
                                </div>
                                <div class="test-details">
                                    <div class="error">
                                        <strong>Error:</strong><br>
                                        ${error.message.replace(/\n/g, '<br>')}
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });
                
                resultsDiv.innerHTML = html;
                updateSummary();
            }, 100);
        }

        function updateSummary() {
            const summaryDiv = document.getElementById('summary');
            summaryDiv.style.display = 'block';
            
            const total = passCount + failCount;
            const successRate = total > 0 ? Math.round((passCount / total) * 100) : 0;
            
            document.getElementById('total-tests').textContent = total;
            document.getElementById('passed-tests').textContent = passCount;
            document.getElementById('failed-tests').textContent = failCount;
            document.getElementById('success-rate').textContent = successRate + '%';
        }

        function createTestData() {
            const testCases = [
                {
                    id: 'test-' + Date.now(),
                    data: {
                        lastName: 'TestCase',
                        firstName: 'Document',
                        birthDate: '2000-01-01',
                        fatherIsGreek: 'true'
                    },
                    category: 'BIRTH_GREEK_PARENT',
                    categoryName: 'Œ§Œ≠Œ∫ŒΩŒø ŒàŒªŒªŒ∑ŒΩŒ± ŒìŒøŒΩŒ≠Œ±',
                    documentStatus: {
                        'birth_cert': { received: true },
                        'passport': { received: false },
                        'parent_citizenship': { received: true, alternativeUsed: 1 },
                        'parent_birth': { received: true, alternativeUsed: 0 },
                        'photos': { received: false }
                    },
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                }
            ];

            const existing = localStorage.getItem('greekCitizenshipCases');
            const cases = existing ? JSON.parse(existing) : [];
            cases.push(...testCases);
            
            localStorage.setItem('greekCitizenshipCases', JSON.stringify(cases));
            
            alert('‚úÖ Test data created! Refresh the main page to see it.');
        }

        function viewLocalStorage() {
            const saved = localStorage.getItem('greekCitizenshipCases');
            if (!saved) {
                alert('No cases found in localStorage');
                return;
            }
            
            const cases = JSON.parse(saved);
            console.log('Cases in localStorage:', cases);
            
            let output = `Found ${cases.length} case(s):\n\n`;
            cases.forEach((c, idx) => {
                output += `Case ${idx + 1}: ${c.data.lastName} ${c.data.firstName}\n`;
                output += `  ID: ${c.id}\n`;
                output += `  Category: ${c.categoryName}\n`;
                if (c.documentStatus) {
                    const docCount = Object.keys(c.documentStatus).length;
                    output += `  Documents tracked: ${docCount}\n`;
                    Object.entries(c.documentStatus).forEach(([id, status]) => {
                        output += `    - ${id}: received=${status.received}, alt=${status.alternativeUsed}\n`;
                    });
                } else {
                    output += `  ‚ö†Ô∏è NO documentStatus field!\n`;
                }
                output += '\n';
            });
            
            alert(output);
            console.log('Full data:', cases);
        }

        function clearAllData() {
            if (confirm('‚ö†Ô∏è This will delete ALL cases from localStorage. Are you sure?')) {
                localStorage.removeItem('greekCitizenshipCases');
                alert('‚úÖ All data cleared. Refresh the page.');
                location.reload();
            }
        }
    </script>
</body>
</html>
